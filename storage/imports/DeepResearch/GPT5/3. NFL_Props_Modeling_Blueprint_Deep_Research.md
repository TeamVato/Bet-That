# Open‑Data NFL Player‑Prop Modeling — Deep Research Blueprint
**Prepared:** September 25, 2025 (UTC)  
**Author:** Project “Bet‑That” Modeling Lead (open‑data first)  
**Scope:** Regular season **and** playoffs • Weekly baseline for all likely contributors • Daily market overlay for posted props only

---

## 0) Executive Summary

**Goal.** Build a production‑ready, **open‑data** system that outputs **calibrated probability distributions** (not just means) for NFL player props (QB/RB/WR/TE: yards, TDs, receptions, attempts, longest plays), integrates injuries and weather, and computes **stable EV** with conservative staking.

**Core Decisions.**
- **Data:** nflverse/nflfastR for play‑by‑play & weekly stats; nflreadr for injuries/rosters/depth; Open‑Meteo + NWS for forecasts; Meteostat for historical weather; The Odds API for posted props. All open/free.
- **Models:** Hierarchical partial‑pooling GLMs by market.  
  - **Counts:** hurdle / zero‑inflated **Poisson/NegBin** (targets, receptions, rush attempts, pass attempts, completions).  
  - **Yards:** **Gamma** (or log‑normal) for positive values with optional hurdle (RB/WR depth).  
  - **TDs:** **Bernoulli** (anytime) + **Poisson/NegBin** for counts (0,1,2+).  
  - **Longest plays:** **Log‑normal** (pragmatic) or tail **GPD**, validated by calibration.
- **Features:** Team PROE/xPass & pace; opponent defense tiers; recent usage & depth; alignment priors; spread/total; weather thresholds (wind ≥ 15–20 mph hits passing); injury status/practice; stadium (dome/outdoor).
- **Calibration:** Reliability diagrams, ECE, Brier & log‑loss; PIT for continuous. Post‑hoc isotonic/Platt **only if needed**.  
- **Market overlay:** Convert to **vig‑free** implied probs and **shrink in logit space** toward market (λ tunable). Use **½‑Kelly** with stake caps.  
- **Production:** Airflow/Prefect DAG from ingestion → features → fit → inference → blend → edges. Weekly artifacts versioned; daily odds/weather snapshots.

**Targets (post‑calibration).**  
Brier ≤ **0.235** (yardage/reception O/Us), log‑loss within **~2%** of market‑only baseline, 80% PI achieving **78–82%** coverage; reliability near diagonal; blended edges mostly **1–10%**.

---

## 1) Key Questions & Search Plan (condensed)
1) **Open data coverage & latency?** → nflverse docs; nflreadr schemas; Odds API markets; Open‑Meteo endpoints.  
2) **Best distributions per market?** → sports modeling forums, papers on skew/zero‑inflation; Stan forum examples.  
3) **Weather effects?** → peer/industry studies on wind/precip/temp; thresholds; dome handling.  
4) **Injury/inactives impact?** → nflreadr injuries fields; studies on “Q but active” performance; practice participation signals.  
5) **Hierarchical pooling?** → partial pooling for players/teams/opponents; temporal decay; cold‑start handling.  
6) **Calibration & scoring?** → Brier/log‑loss; reliability/ECE; PIT; post‑hoc isotonic/Platt.  
7) **Blend with market?** → convex combination with odds; guardrails to avoid extreme bets.  
8) **DAG & caching?** → update schedules; job naming; snapshot/version policy.

---

## 2) Feature Matrix Specification (player–game granularity)

| Column | Type | Description | Source | Refresh |
|---|---|---|---|---|
| season, week, game_id | keys | Identity of game | nflreadr games | static/weekly |
| player_id, pos | keys | Player identifiers (GSIS/PFR), position | nflreadr rosters | daily/weekly |
| team, opp, home_away | cat | Context (H/A) | nflreadr games | weekly |
| spread_line, total_line | num | Pre‑game lines | The Odds API | daily |
| dome_flag, surface | cat | Stadium roof/surface | static map | static |
| team_plays_pg, pace_sp, no_huddle_rate | num | Pace/volume metrics | nflfastR PBP | weekly |
| xpass_mean, **PROE** | num | Expected pass prob & pass‑over‑expected | nflfastR (xPass) | weekly |
| opp_pass_def_eeld, opp_run_def_eeld | num | Opp‑adjusted EPA allowed tiers | nflfastR PBP | weekly |
| player_snap_share, route_rate | num | Weekly participation | snap counts (PFR via nflreadr) | 4× daily / weekly |
| target_share, carry_share | num | Opportunity share | nflfastR player stats | weekly |
| adot, racr, yac_per_rec | num | Efficiency components | nflfastR | weekly |
| qb_cpoe_rolling, aypa | num | QB form | nflfastR | weekly |
| redzone_share, gl_carry_rate | num | Scoring opportunity share | nflfastR | weekly |
| **injury_status** (Q/D/Out), **practice_status_wed/thu/fri** | cat | Availability signals | nflreadr injuries | daily |
| **prob_active** | num | Modeled Pr(active) from practice/status | derived | daily |
| **weather_temp_f, wind_mph, gust_mph, precip_prob, precip_type** | num/cat | Forecast at kickoff (and midgame) | Open‑Meteo/NWS | daily / game‑day |
| **wind15+**, **freezing**, **precip_flag** | bin | Threshold features | derived | daily |
| vegas_prop_line, odds_over, odds_under | num | For posted markets | The Odds API | daily |

**Notes & transforms**  
- PROE from **xPass** aggregation; pace as seconds/play (neutral/trailing).  
- Opponent tiers via ridge‑shrunk EPA allowed (pass/run).  
- Injury → **prob_active** via logistic on practice/status; usage modifiers by injury type (e.g., hamstring → route/ADOT hit).  
- Weather thresholds: wind≥15→passing/air‑yard downtick; ≥20 stronger; dome neutralizes.  
- All rates are EMAs with **decay half‑life ~10–12 weeks**; prior season contributes with position‑specific weights.

---

## 3) Modeling Blueprint (by market)

### 3.1 Counts (attempts/targets/receptions/completions)
- **Structure:** Two‑part **hurdle Negative Binomial (NB2)**.  
  1) *Hurdle:* Pr(Y>0) = logit⁻¹(γ·X_hurdle) with availability/role features.  
  2) *Positive counts:* Y | (Y>0) ~ NB2(mean μ=exp(β·X), overdispersion k_pos_by_position).  
- **Covariates:** team_plays_pg, PROE/xpass, spread/total (script), depth_chart_rank, recent usage, opp pass def tier, man/zone proxy, weather (wind reduces attempts depth; receptions may rise via short game).  
- **Random effects (REs):** player, team_offense, opp_defense, season; optional correlated REs (player with team).

### 3.2 Yardage (passing, rushing, receiving)
- **Option A (preferred):** **Gamma GLM** with log link for positive yards + optional hurdle for long‑tail WR4/RB2 zeros.  
- **Option B:** log‑normal on log(yards+1).  
- **Decomposition path (RB/WR):** yards = volume × efficiency.  
  - Volume ~ NB2 (attempts or receptions).  
  - Efficiency ~ Gamma (YPA/YPR) with defense/weather/alignment drivers.  
  - Compose via Monte Carlo (10–50k draws) to recover full yardage distribution.  
- **Weather:** wind splines or thresholds; freezing temp slight YPA/YPR penalty; precip small YAC/efficiency hit; **dome ≈ neutral**.

### 3.3 Touchdowns
- **Anytime TD:** Bernoulli GLM: logit Pr(TD≥1) = f(team implied TDs from total/spread, redzone_share, GL carries, opp RZ defense).  
- **TD counts (0/1/2+):** **Poisson/NegBin** with mean from team implied TDs × player share; calibrate tails vs empirical.

### 3.4 Longest Play (LR/LRsh/LC)
- **Pragmatic:** **Log‑normal** for longest gain; features: explosive play rate, ADOT, YAC ability, defense explosive‑allowed, wind.  
- **Alternative:** Tail **GPD** fit per position for >X‑yard tail; more complex, validate with PIT.

### 3.5 Priors, Pooling, Time
- **Partial pooling:** REs for player/team/opp; position‑specific variance.  
- **Temporal decay:** EMA with **half‑life 10–12 weeks**; last season down‑weighted (rookies use prospect priors).  
- **Cold‑start:** aggressive pooling to positional/team means; include depth‑chart‑based role priors.  
- **Uncertainty inflation:** widen PIs for high forecast weather uncertainty / volatile roles.

---

## 4) Calibration & Acceptance

**What we score:**  
- **Binary O/U** at posted lines: **Brier** and **log‑loss**; reliability diagrams (10–20 bins), **ECE**, sharpness (variance).  
- **Continuous**: **PIT** histograms & **interval coverage** (e.g., 80% PI → 78–82%).

**Protocol:**  
1) **Backtests** on prior seasons (no look‑ahead).  
2) **Reliability** vs our model and **vs market implied** (vig‑free).  
3) **Post‑hoc calibration** only if needed (Platt / Isotonic per market).  
4) **Blend with market** (below) is part of deployment, not training.

**Acceptance thresholds (post‑calibration):**  
- Brier ≤ **0.235** (yardage/reception O/U); TD/longest tails ≤ **0.24** acceptable.  
- Log‑loss: ≥ **2%** lower than market‑only baseline (rolling 4‑week windows).  
- 80% PI coverage within **78–82%**; KS(PIT) ≤ **0.07**.  
- Reliability: near‑diagonal; no systematic overconfidence.

---

## 5) Market Overlay (edges only)

**Vig‑free conversion** (American odds → implied probs → normalize to sum=1).  
**Shrinkage:** in **logit space**:  
\[
\text{logit}(p_\text{final}) = (1-\lambda)\,\text{logit}(p_\text{model}) + \lambda\,\text{logit}(p_\text{market})
\]  
- **λ tuning:** CV by time & sample depth (larger early season/thin samples).  
- **Guardrails:** cap max pull; block edges < threshold; sanity checks for outliers.

**Bet sizing:** **½‑Kelly** with stake caps (e.g., ≤ 2% bankroll). Prefer few, higher‑confidence edges.

**SQL** (vig‑free example):
```sql
-- Convert American odds to raw implied probabilities
CREATE OR REPLACE VIEW implied_probs_raw AS
SELECT
  *,
  CASE WHEN odds_over  < 0 THEN (-odds_over)  / ((-odds_over)  + 100.0)
       ELSE 100.0 / (odds_over  + 100.0) END AS p_over_raw,
  CASE WHEN odds_under < 0 THEN (-odds_under) / ((-odds_under) + 100.0)
       ELSE 100.0 / (odds_under + 100.0) END AS p_under_raw
FROM odds;

-- Normalize to remove vig
CREATE OR REPLACE VIEW implied_probs AS
SELECT
  *,
  p_over_raw  / (p_over_raw + p_under_raw)  AS p_over,
  p_under_raw / (p_over_raw + p_under_raw)  AS p_under
FROM implied_probs_raw;
```

**Python** (blend + ½‑Kelly):
```python
import math
def logit(p): return math.log(p/(1-p))
def inv_logit(z): return 1/(1+math.exp(-z))

def blend_prob(p_model, p_market, lam=0.35):
    return inv_logit((1-lam)*logit(p_model) + lam*logit(p_market))

def kelly_fraction(p, dec_odds):
    # Kelly for decimal odds
    return max((p*dec_odds - 1) / (dec_odds - 1), 0.0)

# Example
p_model  = 0.58
p_market = 0.50
p_final  = blend_prob(p_model, p_market, lam=0.35)
dec_odds = 1.91  # ~ -110
kelly    = kelly_fraction(p_final, dec_odds) / 2  # half‑Kelly
```

---

## 6) Directional Effects (priors & variance)

- **Defense tiers (opp‑adj EPA):** strong pass D ↓ QB YPA & WR/TE yards; RB targets may ↑. Variance ↑ vs heavy man/pressure (boom/bust).  
- **PROE / Pace:** ↑ PROE + faster pace → ↑ QB attempts & WR/TE targets; RB carries ↓ but RB receptions often ↑. Variance ↑ in high‑tempo.  
- **Injuries:** If **active**, average impact small; specific types (hamstring/shoulder) may hit snap share/ADOT/catch radius modestly. **Q tags** ↑ variance → use availability mixture.  
- **Weather:** **Wind ≥15–20 mph** depresses passing efficiency/volume; rush share ↑; deep‑threat WR “longest” variance ↑. Precip modest efficiency/YAC hit. **Domes neutralize.**  
- **Alignment/personnel:** Slot WRs steadier reception floors (short aDOT, lower var). Boundary deep threats higher variance. TE inline vs slot shifts aDOT & catch%.

---

## 7) Production Plan (DAG, artifacts, snapshots)

```mermaid
flowchart LR
    subgraph INGEST
        A[PBP/stats] --> F[Features (weekly)]
        B[Snap counts] --> F
        C[Rosters/Depth] --> F
        D[Injuries] --> G[Features (daily)]
        E[Odds] --> G
        W[Weather] --> G
    end
    subgraph MODEL
        F --> M[Train/Update weekly]
        M --> P[Predict daily]
        G --> P
    end
    subgraph EDGE ENGINE
        P --> S[Shrink to market]
        S --> R[EV & 1/2‑Kelly]
        R --> O1[Publish edges]
        R --> O2[API/DB]
    end
```

### Jobs (suggested names)
**Raw ingestion**
- `ingest_pbp_weekly` (nflfastR parquet); `ingest_snapcounts_weekly` (PFR);  
- `ingest_rosters_depth_daily` (nflreadr); `ingest_injuries_daily`;  
- `ingest_odds_daily` (The Odds API); `ingest_weather_daily` (Open‑Meteo/NWS).

**Feature builds**
- `f_team_tendencies_weekly` (PROE, pace, xPass splits),  
- `f_defense_tiers_weekly` (opp‑adj EPA tiers, RZ rates, explosive‑allowed),  
- `f_player_usage_weekly` (route/snap share, target/carry shares, EMAs; alignment priors),  
- `f_injury_availability_daily` (Pr(active), modifiers),  
- `f_weather_features_daily` (thresholds & splines; dome flags).

**Modeling & predictions**
- `m_fit_props_weekly` (hierarchical GLMs per market; save params & REs),  
- `m_predict_distributions_daily` (quantiles/params or MC samples per player‑prop),  
- `m_calibration_update_weekly` (reliability curves, isotonic/Platt if needed).

**Edge overlay**
- `edge_vigfree_odds_daily` → `edge_blend_market_daily` → `edge_outputs_daily` (EV, stake, rationale).

**Snapshots & versioning**
- **Daily:** `odds_raw`, `edge_outputs`.  
- **Weekly:** `model_params_v{week}`, `calibration_models_v{week}`.  
- **Lock:** final weather, inactives, closing odds.

**APIs / surfaces**
- `/projections/{week}` (baseline distributions),  
- `/edges/{date}` (posted markets only),  
- `/calibration/{window}` (scorecards & plots).

**Monitoring & alerts**
- Ingestion failures, extreme edges, calibration drift alarms; post‑mortems each week.

---

## 8) Data Gaps & Fallbacks (2025 reality)
- **Injury endpoint instability:** Prefer `nflreadr` injuries; cross‑check **official inactives** 90 min pre‑kick; keep **manual override** table.  
- **Participation/alignment latency:** Use prior‑season alignment priors + depth/route proxies in‑season; refresh postseason.  
- **Weather station mismatch:** Geocode stadiums; use **NWS gridpoints**; backup **Open‑Meteo**; inflate uncertainty under high forecast variance.

---

## 9) Evidence Table (selected open sources)

| Title | Org/Author | Year | Why it matters | Link |
|---|---|---:|---|---|
| nflfastR EP/WP/CP/xPass docs & calibration notes | nflfastR / Baldwin et al. | 2021 | Open EP/WP/CP/xPass methods; leave‑one‑season‑out calibration practices for NFL models | https://www.nflfastr.com/reference/calculate_expected_points.html |
| nflverse / nfl_data_py / nflreadr | nflverse | 2022–25 | Open pipelines for PBP, rosters, depth, injuries, weekly stats; update schedules | https://github.com/nflverse/nfl_data_py • https://nflreadr.nflverse.dev |
| Injuries endpoint issue (instability) | nflverse issue | 2024–25 | Notes instability of Python injury endpoint; motivates redundancy/fallbacks | https://github.com/nflverse/nfl_data_py/issues/145 |
| Weather & passing study | Wharton (Parks et al.) | 2022 | Quantifies weather effects; supports wind/temperature adjustments | https://wsb.wharton.upenn.edu/wp-content/uploads/2022/09/2022_Football_Parks_Weather.pdf |
| Open‑Meteo Forecast API | Open‑Meteo | 2024–25 | Free hourly forecasts (wind/temp/precip) with coordinates | https://open-meteo.com |
| NWS API (U.S.) | NOAA/NWS | 2024–25 | Official U.S. gridpoint forecasts; complementary to Open‑Meteo | https://api.weather.gov |
| Meteostat | Meteostat | 2024–25 | Historical weather for calibration/backfill | https://meteostat.net |
| The Odds API (player props) | The Odds API | 2023–25 | NFL player prop markets/odds; used for daily overlay | https://the-odds-api.com |
| Brier score | Wikipedia | — | Definition & usage for probability scoring | https://en.wikipedia.org/wiki/Brier_score |
| Cross‑entropy / log‑loss | Wikipedia | — | Definition for log‑loss scoring | https://en.wikipedia.org/wiki/Cross_entropy |
| Kelly criterion & cautions | Investopedia | — | Background on Kelly; motivates half‑Kelly & caps | https://www.investopedia.com/terms/k/kellycriterion.asp |
| Stan forum: hurdle/gamma for skewed sports outcomes | Stan community | 2024 | Practitioner evidence favoring hurdle‑Gamma / Gamma over log‑normal in some fits | https://discourse.mc-stan.org/ |

> *Caveat:* Some entries summarize broader threads; precise URLs may vary. We will maintain a living bibliography with permalinks in the repo.

---

## 10) Glossary
**EPA:** Expected Points Added per play (efficiency).  
**CPOE/CP:** Completion Probability Over Expected / raw Completion Probability.  
**xPass / PROE:** Expected pass rate model / Pass Rate Over Expected (actual – expected).  
**ECE:** Expected Calibration Error (reliability summary).  
**PIT:** Probability Integral Transform for continuous calibration.  
**NB2:** Negative Binomial (variance > mean).  
**Hurdle model:** Two‑part model: Pr(Y=0) vs Y|Y>0 distribution.  
**Vig:** Bookmaker margin in odds.  
**½‑Kelly:** Half Kelly fraction for risk‑controlled staking.

---

## 11) Example Inference Recipe (Receiving Yards O/U 59.5)

1) Sample **targets** ~ hurdle‑NB2 with features (PROE, pace, role, defense).  
2) Sample **catch%** with logistic GLM (CPOE proxy, aDOT, slot/inline, defense man/zone).  
3) Sample **YPR** ~ Gamma/log‑normal with weather/defense/alignment covariates.  
4) Compose yards = catches × YPR; draw **10–50k** MC samples.  
5) Compute p_model = Pr(yards > 59.5).  
6) Convert book to **vig‑free** p_market; **blend** in logit space → p_final.  
7) Compute **EV** and **½‑Kelly** stake with caps & guardrails.

---

## 12) Iteration Hooks (next research sprints)

1) **Availability & usage model:** logistic Pr(active) and snap% regression from practice tags & injury types; quantify modifiers by body part/position.  
2) **Weather splines:** fit smooth wind/temp/precip effects with interactions; validate on PIT and reliability (reduce threshold heuristics).  
3) **Team‑game random effect:** introduce same‑game team RE to capture co‑movement among teammates; useful for portfolio risk and parlays.

---

## 13) Implementation Notes
- **ID hygiene:** unify `gsis_id`, `pfr_id`, `nfl_id` via nflverse dictionaries.  
- **Cold‑start rookies:** prospect priors (measurables + role) with strong pooling.  
- **No leakage:** train on **pre‑close** snapshots; evaluate vs closing lines.  
- **Two tracks:** keep **market‑unaware** research outputs and **market‑aware** deployment outputs.  
- **Explainability:** log GLM contributions and REs per player‑prop; attach top drivers to each edge.

---

### Appendix A — Minimal dbt model names
- `stg_nfl_pbp`, `stg_nfl_snaps`, `stg_nfl_rosters`, `stg_nfl_injuries`, `stg_nfl_odds`, `stg_weather`;  
- `f_team_tendencies_weekly`, `f_defense_tiers_weekly`, `f_player_usage_weekly`, `f_injury_availability_daily`, `f_weather_features_daily`;  
- `m_params_*` (per market), `m_draws_*` (optional), `m_probs_ou`, `calibration_curves`;  
- `edge_join_odds`, `edge_outputs`.

### Appendix B — Reliability plot (Python)
```python
import numpy as np, matplotlib.pyplot as plt

def reliability_curve(pred_probs, outcomes, bins=10):
    bins = np.linspace(0,1,bins+1)
    idx = np.digitize(pred_probs, bins) - 1
    x, y, n = [], [], []
    for i in range(len(bins)-1):
        m = idx == i
        if m.sum() == 0: 
            continue
        x.append(pred_probs[m].mean())
        y.append(outcomes[m].mean())
        n.append(m.sum())
    plt.plot([0,1],[0,1],'--',lw=1)
    plt.scatter(x, y, s=np.clip(np.array(n), 20, 120))
    plt.xlabel('Predicted probability'); plt.ylabel('Observed frequency')
    plt.title('Reliability Diagram'); plt.show()
```

### Appendix C — Yardage distribution assembly (MC)
```python
import numpy as np

def sample_yards(n_draws, lambda_targets, p_nonzero, catch_logit, ypr_mu, ypr_sigma):
    # 1) Targets: hurdle + NB approx via Gamma-Poisson
    z = np.random.binomial(1, p_nonzero, size=n_draws)
    # Poisson-Gamma (NegBin) approx for targets when z=1
    targ = np.where(z==1, np.random.poisson(lambda_targets, size=n_draws), 0)
    # 2) Catches: Binomial with catch%
    catch_p = 1/(1+np.exp(-catch_logit))
    catches = np.array([np.random.binomial(t, catch_p) for t in targ])
    # 3) YPR: log-normal draws for efficiency
    ypr = np.random.lognormal(mean=np.log(max(1e-6,ypr_mu)), sigma=ypr_sigma, size=n_draws)
    yards = catches * ypr
    return yards
```

---

## License & Attributions
- Built on **nflverse** (nflfastR/nflreadr) and public forecast/odds APIs.  
- This document is provided for internal planning and engineering execution.

